```
license:	GNU GENERAL PUBLIC LICENSE  Version 3, 29 June 2007
author:		arvik
email:		1216601195@qq.com
blog:		http://blog.csdn.net/u012819339
github:		https://github.com/arviklinux/impush
date:		2017.03.07
```
#IM_PUSH消息推送协议拟定

##IM_PUSH消息固定报头
```
0      7      15       23      31
--------------------------------
| ver   | type  | warn  |reserve|
--------------------------------
|      len      | session_id    |
--------------------------------
```
ver:协议版本，影响协议报头的解析方式
type:消息类型（基数则表示设备发送报文，偶数表示服务器发送报文），双方一句对方发来的消息类型进行相同消息类型的应答
```
	3  sign: 注册，客户端发送自身mac等信息给服务器(设备初次登录前使用，当设备拥有服务器回复的唯一码后永久不再需要该报文)，服务器根据客户端发送的sign报文中的信息，判断是否是合法的设备，合法则记录客户端相应的信息并生成一份4个字节的设备唯一码，回复给客户端，客户端需要存储该设备码用于登录
	5  login: 使用设备码登录可让服务器记录在线状态
	7  logout: 发送客户端离线消息
	9  alive: 连接保活，客户端在最后一次通信后隔一段确定的时间用来确认连接是否中断
	10  spush: 服务器主动推送消息给客户端
	11  cpush：客户端主动推送消息给服务器
```
warn: 当type为0或1时用作协议指出错误类型（用于应答报文，具体代表那些信息由通信双方约定）
```
		0： 无错误
		1： 版本错误
		2： ...（自行约定）
	 当type为其他内容时，同样根据type值，由协议约定该字段含义
```
reserve:保留
len: 报文长度，（ver, type，warn，reserve， len，seesion_id字段不计算在内）
session_id: 会话id，每一对请求和应答session_id相同，不同次请求该id值不同，每一次会话中，发送者随机产生该值（和上一次不一样），应答者回复报文中报头该字段需和发送者的session_id一样



##每种报文解释以及通信示例
###sign
sign消息由客户端发送，报文type字段值为3，默认信息是8个字节，所以len字段值是8，报文附带8个字节信息的body，信息必须确保唯一（IM_PUSH建议客户端采用 6Bytes的mac + 2Bytes厂商代号组成信息来确保设备信息全球唯一），具体信息由使用者决定。客户端需记录服务器返回的Unique_id

注意：
1、如果服务器收到设备使用的8个字节的信息后，应先查表，如果查找记录过该信息则返回上一次分配过的Unique_id，如果未记录则返回新的Unique_id
2、一个设备终生只用发送一次该报文，除非客户端忘记了服务器返回的Unique_id，则可用此报文获取相同的Unique_id

此时服务器按照如下步骤操作
1.验证客户端信息的合法性(判断是否是自己记录或承认的设备)
2.记录信息，并从最近一次分配出去的Unique_id自加后，作为该设备的独有设备id
3.将这份独有设备id回复给客户端



**示例报文**
客户端：
```
0      7      15       23      31
--------------------------------
|   1   |   3   |  0   |   0   |
--------------------------------
|       8       |   0xfc3d     |
--------------------------------
    aa:bb:cc:dd:ee:ff 00 00    |
                               |
--------------------------------
```

服务器回复：
（成功范例）
```
0      7      15       23      31
--------------------------------
|   1   |   3   |  0   |   0   |
--------------------------------
|       4       |   0xfc3d     |
--------------------------------
           0x00000001          |
--------------------------------
```
（失败范例） warn字段定义了失败原因，成功则warn字段值为0
```
0      7      15       23      31
--------------------------------
|   1   |   3   |  1   |   0   |
--------------------------------
|       0       |   0xfc3d     |
--------------------------------
```

###login
客户端登录服务器，报文type字段值为3，信息是4个字节，所以len字段值是4，报文附带4个字节信息的body，该body仅仅含有服务器为此设备分配的Unique_id

服务器记录该状态，记录该条连接描述符，以后从该条连接传送上来的数据都视为该设备发送的消息


**示例报文**
客户端：
```
0      7      15       23      31
--------------------------------
|   1   |   5   |  0   |   0   |
--------------------------------
|       4       |   0x3cfa     |
--------------------------------
           0x00000001          |
--------------------------------
```

服务器回复（成功范例）：
```
0      7      15       23      31
--------------------------------
|   1   |   5   |  0   |   0   |
--------------------------------
|       0       |   0x3cfa     |
--------------------------------
```
（失败范例） warn字段定义了失败原因，成功则warn字段值为0
```
0      7      15       23      31
--------------------------------
|   1   |   5   |  1   |   0   |
--------------------------------
|       0       |   0x3cfa     |
--------------------------------
```

###logout
客户端发送退出登录的消息给服务器，服务器则释放和该设备通信用的套接字描述符以及释放该次链接过程中使用的其他资源。

**示例报文**
客户端：
```
0      7      15       23      31
--------------------------------
|   1   |   7   |  0   |   0   |
--------------------------------
|       0       |   0xba5e     |
--------------------------------
```

服务器回复（成功范例）：
```
0      7      15       23      31
--------------------------------
|   1   |   7   |  0   |   0   |
--------------------------------
|       0       |   0xba5e     |
--------------------------------
```
（失败范例） warn字段定义了失败原因，成功则warn字段值为0
```
0      7      15       23      31
--------------------------------
|   1   |   7   |  1   |   0   |
--------------------------------
|       0       |   0xba5e     |
--------------------------------
```

###alive
客户端发送该数据包来维护链接，相当于心跳包，让服务器知道该设备处于活跃状态

注意：
心跳包只能由客户端主动发送，服务器在上一次客户端数据到达后经过时间timeout后如果还未收到该链接中的任何一条消息，则视为该客户端下线，强制更改记录客户端在线状态，并释放相应资源

同理：客户端发送alive报文经过时间RTIT(Response time interval timeouts回复时间间隔超时)后如果还未收到回复，则认为服务器不在线

**示例报文**
客户端：
```
0      7      15       23      31
--------------------------------
|   1   |   9   |  0   |   0   |
--------------------------------
|       0       |   0xa361     |
--------------------------------
```

服务器回复：
```
0      7      15       23      31
--------------------------------
|   1   |   9   |  0   |   0   |
--------------------------------
|       0       |   0xa361     |
--------------------------------
```

###spush
服务器主动推送消息给客户端

**示例报文**
服务器：
```
0      7      15       23      31
--------------------------------
|   1   |  10   |  0   |   0   |
--------------------------------
|      12       |   0x11c5     |
--------------------------------
hello,arvik!
--------------------------------
```

客户端回复：
```
0      7      15       23      31
--------------------------------
|   1   |   10  |  0   |   0   |
--------------------------------
|       0       |   0x11c5     |
--------------------------------
```

###cpush
客户端主动推送消息给服务器
此时：
warn字段为0，表示普通信息上报
warn字段为1，表示推送一条广播消息，服务器在验证权限后会将该消息广播给所有在线设备
warn字段为2，表示推送一条消息到指定设备（报头后面接的8个字节的指定某台在线设备）服务器在验证权限后会将该消息推送给指定的在线设备

**示例报文**
服务器：
```
0      7      15       23      31
--------------------------------
|   1   |  11   |  0   |   0   |
--------------------------------
|      12       |   0x6da1     |
--------------------------------
hello,arvik!
--------------------------------
```

客户端回复：
```
0      7      15       23      31
--------------------------------
|   1   |   11  |  0   |   0   |
--------------------------------
|       0       |   0x6da1     |
--------------------------------
```



	  
	
    